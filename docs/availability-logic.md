# 空席判定ロジックの概要

このドキュメントでは、`src/availability.ts` に実装されているサンライズ瀬戸・出雲の空席判定ロジックの仕組みと、調査で判明した不具合、修正内容をまとめます。

## これまでの課題

従来の実装では、HTML 全体を文字列化し、部屋タイプ名の近傍 40 文字だけを対象に空席キーワードを探していました。アイコン画像の `src` 属性などが長くなると、肝心の `alt="空席状況：○"` のような文字列が判定窓から外れてしまい、空席状況が常に `unknown` になるケースがありました。また、どのアイコンが表示されているかという DOM 構造を把握していないため、`残席なし` 以外のアイコンを取り逃がすリスクも高く、Playwright での E2E テストもしづらい状態でした。

## 改善後の判定フロー

1. **フォーム行の直接解析**
   Playwright で取得したページ上から、対象のラジオボタン行 (`tr`) を特定します。`tr > td > img` という構造で並ぶ空席ステータスアイコンを走査し、`alt` / `aria-label` / `title` のいずれかに `残席なし`（または同義語）が含まれていれば満席、1 つでも異なる文言のアイコンがあれば空席ありと判定します。検出したアイコン文言はそのまま判定根拠として保持します。
2. **属性／テキストのフォールバック**
   アイコンが存在しない、もしくは文言が読み取れない場合は、行内の他の `alt` / `aria-label` / `title` 属性およびテキストノードを順番に解析し、既存の空席／満席キーワードマッチングを適用します。
3. **HTML 全体のテキストマッチ**
   行単位でも判定できない場合の最終手段として、ページ全体の HTML を正規化し、部屋タイプに紐づくキーワードの周辺 160 文字をスキャンします。ここでも空席／満席キーワードが検出できれば判定します。
4. **キーワード管理の一元化**
   空席／満席キーワードは正規化済みのエントリとして管理し、フォールバック処理でも同じマッチングロジックを再利用します。判定時には一致した元キーワードを `indicatorText` として格納し、ログ出力にも利用します。

## 拡張時のガイドライン

- 新しいキーワードを追加する場合は `src/constants.ts` の `POSITIVE_KEYWORDS` / `NEGATIVE_KEYWORDS` に追記してください。正規化は自動的に適用されます。
- 特殊な表記ゆれがある場合は、`ROOM_TYPE_KEYWORDS` に別名を追加することでマッチ精度を高められます。
- DOM 構造に大きな変更が入った場合は、`resolveRoomAvailabilityFromPage`（フォーム行解析）と `extractAvailabilityFromRow`（行内属性解析）を確認してください。とくに `td` 内のアイコン構造が変わった場合は、スナップショットテスト（`tests/availability.test.ts`）を更新し、想定どおりのシナリオを網羅してください。

## トラブルシューティング

- **常に判定不可になる**: ブラウザ自動操作がフォーム行を取得できていない可能性があります。対象の部屋タイプのラジオボタンが存在するか、`roomTypes` 設定が正しいかを確認してください。
- **誤検知が発生する**: 新しい文言が空席／満席キーワードに類似している場合があります。`docs/availability-logic.md` を参考にキーワードの追加・調整を行ってください。

以上が判定ロジックの現状と修正内容です。運用中に挙動に違和感があれば、このフローとキーワードリストを起点に調査を行ってください。
